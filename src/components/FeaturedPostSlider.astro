---
/* Server-side data fetching */
import { getCollection } from 'astro:content';
import filterPublishedPosts from '../utilities/filterPublishedPosts';
import { formatInTimeZone } from 'date-fns-tz';

// Get all blog posts and filter for featured ones
const allPosts = await getCollection('blog');
const publishedPosts = filterPublishedPosts(allPosts);
const featuredPostsData = publishedPosts.filter(post => post.data.featured === true);

// Format date helper function
const formatDate = (date: Date) => {
  return formatInTimeZone(date, 'Etc/UTC', 'MMMM dd, yyyy');
};

// Map featured posts to slider format
const featuredPosts = featuredPostsData.length > 0 ? featuredPostsData.map(post => ({
  tag: post.data.topics.length > 0 ? post.data.topics[0] : 'Blog',
  title: post.data.title,
  date: formatDate(post.data.pubDate),
  description: post.data.description,
  imageSrc: post.data.heroImage || "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?q=80&w=2070&auto=format&fit=crop",
  link: `/writing/${post.slug}/`
})) : [
  // Fallback data if no featured posts exist
  {
    tag: "Blog",
    title: "Welcome to Our Blog",
    date: "January 1, 2024",
    description: "Check back soon for featured content.",
    imageSrc: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?q=80&w=2070&auto=format&fit=crop",
    link: "/writing/"
  }
];
---

<section class="featured-slider" id="featured-slider">
  <div class="slider-wrapper">
    
    {featuredPosts.map((post, index) => (
      <div class={`slide ${index === 0 ? 'active' : ''}`} data-index={index}>
        
        <div class="image-col">
          <img src={post.imageSrc} alt={post.title} />
        </div>

        <div class="content-col">
          <div class="meta-top">
            <span class="tag">{post.tag}</span>
          </div>
          
          <h2 class="title">{post.title}</h2>
          <p class="date">{post.date}</p>
          <p class="description">{post.description}</p>
          
          <div class="actions">
            <a href={post.link} class="read-btn">Read article</a>
            
            <div class="nav-controls">
              <button class="nav-btn prev-btn" aria-label="Previous Post">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
              </button>
              <button class="nav-btn next-btn" aria-label="Next Post">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
              </button>
            </div>
          </div>
        </div>
        
      </div>
    ))}

  </div>
</section>

<style>
  .featured-slider {
    position: relative;
    max-width: 1200px;
    margin: 4rem auto; /* Spacing from other sections */
    padding: 0 1.5rem;
    color: var(--color-text);
  }

  .slider-wrapper {
    position: relative;
    min-height: 500px; /* Adjust based on preference */
  }

  /* Slide Layout */
  .slide {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    
    /* Animation setup */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease-in-out, visibility 0.5s;
    z-index: 0;
  }

  .slide.active {
    position: relative; /* Relative so it takes up space in the flow */
    opacity: 1;
    visibility: visible;
    z-index: 1;
  }

  /* Image Column */
  .image-col {
    flex: 1;
    border-radius: 24px;
    overflow: hidden;
    height: 350px;
  }

  .image-col img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Content Column */
  .content-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 1rem;
  }

  /* Typography matching the screenshot */
  .tag {
    display: inline-block;
    background-color: var(--color-tag);
    padding: 0.4rem 1rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 1.5rem;
    color: var(--color-text);
  }

  .title {
    font-size: 3rem; /* Large display size */
    line-height: 1.1;
    margin: 0 0 1rem 0;
    font-weight: 600;
    letter-spacing: -0.02em;
  }

  .date {
    font-size: 0.9rem;
    opacity: 0.6;
    margin: 0 0 1.5rem 0;
  }

  .description {
    font-size: 1.1rem;
    line-height: 1.6;
    margin: 0 0 2.5rem 0;
    max-width: 45ch;
    opacity: 0.9;
  }

  /* Actions Area */
  .actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    border-top: 1px solid rgba(62, 48, 41, 0.1);
    padding-top: 2rem;
  }

  .read-btn {
    text-decoration: none;
    color: var(--color-text);
    border: 1px solid var(--color-text);
    padding: 0.75rem 2rem;
    border-radius: 50px;
    transition: all 0.2s ease;
  }

  .read-btn:hover {
    background-color: var(--color-text);
    color: var(--color-bg);
  }

  /* Navigation Buttons */
  .nav-controls {
    display: flex;
    gap: 0.5rem;
  }

  .nav-btn {
    background: transparent;
    border: 1px solid var(--color-text);
    color: var(--color-text);
    width: 44px;
    height: 44px;
    border-radius: 50%; /* Circular buttons */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-btn:hover {
    background-color: var(--color-text);
    color: var(--color-bg);
  }

  /* Desktop Styles */
  @media (min-width: 900px) {
    .slide {
      flex-direction: row;
      align-items: center;
      gap: 4rem;
    }

    .image-col {
      height: 500px; /* Taller on desktop */
      flex: 1.2; /* Image takes slightly more width */
    }
    
    .content-col {
      flex: 1;
    }

    .actions {
      border-top: none; /* Remove border on desktop for cleaner look, or keep it */
      padding-top: 0;
      justify-content: flex-start;
      gap: 3rem;
    }
  }
</style>

<script>
  // Simple client-side logic for the slider
  function initSlider() {
    const slider = document.getElementById('featured-slider');
    if (!slider) return;

    const slides = slider.querySelectorAll('.slide');
    const prevBtns = slider.querySelectorAll('.prev-btn');
    const nextBtns = slider.querySelectorAll('.next-btn');
    
    let currentIndex = 0;
    const totalSlides = slides.length;

    function showSlide(index) {
      // Hide all slides
      slides.forEach(slide => {
        slide.classList.remove('active');
      });
      
      // Show target slide
      slides[index].classList.add('active');
    }

    function nextSlide() {
      currentIndex = (currentIndex + 1) % totalSlides;
      showSlide(currentIndex);
    }

    function prevSlide() {
      currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
      showSlide(currentIndex);
    }

    // Attach listeners to ALL buttons (since there are buttons inside each slide)
    nextBtns.forEach(btn => btn.addEventListener('click', nextSlide));
    prevBtns.forEach(btn => btn.addEventListener('click', prevSlide));
  }

  // Run on load
  initSlider();
  
  // Re-run on Astro page transitions (if view transitions are enabled)
  document.addEventListener('astro:page-load', initSlider);
</script>
