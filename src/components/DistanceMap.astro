---
const from = {
  name: "Göttingen, Germany",
  lat: 51.520733,
  lng: 9.939794,
};
---

<div class="map-card">
  <div id="map" class="map map-loading"></div>

  <p class="caption" id="caption">
    Calculating distance…
  </p>
</div>

<script>
  import mapboxgl from "mapbox-gl";
  import { addRouteAndMarkers } from "../utilities/map.js";

  mapboxgl.accessToken = import.meta.env.PUBLIC_MAPBOX_TOKEN;

  const from = {
    lat: 51.520733,
    lng: 9.939794,
  };

  let mapInitialized = false;

  function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;

    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  async function getUserLocation() {
    try {
      console.log('Attempting IP-based geolocation...');

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

      const res = await fetch("/api/geo", {
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
        }
      });

      clearTimeout(timeoutId);

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();
      console.log('IP-based location API response:', data);

      // Validate the response data
      if (!data.latitude || !data.longitude) {
        throw new Error('Invalid location data: missing coordinates');
      }

      // Parse coordinates to ensure they're numbers
      const lat = parseFloat(data.latitude);
      const lng = parseFloat(data.longitude);

      if (isNaN(lat) || isNaN(lng)) {
        throw new Error('Invalid location data: coordinates are not valid numbers');
      }

      // Check if coordinates are reasonable (not 0,0 which indicates failure)
      if (lat === 0 && lng === 0) {
        throw new Error('Invalid location data: coordinates are 0,0');
      }

      return {
        lat: lat,
        lng: lng,
        city: data.city || 'Unknown City',
        country: data.country || 'Unknown Country',
      };
    } catch (error) {
      console.error('IP-based geolocation failed:', error);
      return null;
    }
  }

  function initializeMap() {
    if (mapInitialized) return;
    mapInitialized = true;

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v11",
      projection: "globe",
      center: [0, 20],
      zoom: 0.8,
    });

    // Remove loading class
    const mapElement = document.getElementById("map");
    if (mapElement) {
      mapElement.classList.remove("map-loading");
    }

    map.on("load", async () => {
      try {
        const user = await getUserLocation();

        if (!user) {
          console.warn('Failed to get user location, using fallback display');
          const captionElement = document.getElementById("caption");
          if (captionElement) {
            captionElement.innerHTML = `
              I’m currently in Göttingen, Germany.
              <br><small style="color: #64748b;">(Unable to determine your location)</small>
            `;
          }

          // Still show the map centered on Göttingen with a default zoom
          map.easeTo({
            center: [from.lng, from.lat],
            zoom: 8,
            duration: 3500,
            easing: (t) => 1 - Math.pow(1 - t, 4),
          });

          map.once("moveend", () => {
            // Add marker for Göttingen only
            addRouteAndMarkers(map, from, null);
          });
          return;
        }

        console.log('User location:', user);

        const distance = haversineDistance(
          from.lat,
          from.lng,
          user.lat,
          user.lng
        ).toFixed(0);

        const captionElement = document.getElementById("caption");
        if (captionElement) {
          captionElement.innerHTML = `
            I’m currently in Göttingen, Germany, roughly
            <strong>${distance} km</strong> away from your location
            (${user.city}, ${user.country}).
          `;
        }

        // Map bounds
        const minLng = Math.min(from.lng, user.lng);
        const maxLng = Math.max(from.lng, user.lng);
        const minLat = Math.min(from.lat, user.lat);
        const maxLat = Math.max(from.lat, user.lat);

        const mapEl = document.getElementById("map");
        if (!mapEl) return;

        const mapWidth = mapEl.clientWidth;
        const mapHeight = mapEl.clientHeight;

        const tileSize = 512;
        const paddingFactor = 0.85;

        const zoomLng = Math.log2((mapWidth * 360) / (tileSize * (maxLng - minLng))) * paddingFactor;
        const zoomLat = Math.log2((mapHeight * 360) / (tileSize * (maxLat - minLat))) * paddingFactor;

        const zoom = Math.min(zoomLng, zoomLat, 20);

        const center: [number, number] = [(from.lng + user.lng) / 2, (from.lat + user.lat) / 2];

        map.easeTo({
          center,
          zoom,
          duration: 3500,
          easing: (t) => 1 - Math.pow(1 - t, 4), // Cubic ease-out: fast start, slow finish
        });

        map.once("moveend", () => {
          addRouteAndMarkers(map, from, user);
        });
      } catch (error) {
        console.error('Error in map load handler:', error);
        const captionElement = document.getElementById("caption");
        if (captionElement) {
          captionElement.innerHTML = `
            I’m currently in Göttingen, Germany.
            <br><small style="color: #dc2626;">(Error loading location data)</small>
          `;
        }
      }
    });
  }

  // Set up intersection observer for lazy loading
  document.addEventListener('DOMContentLoaded', () => {
    const mapCard = document.querySelector('.map-card');

    if (!mapCard) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            initializeMap();
            observer.disconnect(); // Only load once
          }
        });
      },
      {
        rootMargin: '0px', // No margin - trigger exactly when element enters viewport
        threshold: 1.0, // Trigger only when 100% of the element is visible
      }
    );

    observer.observe(mapCard);
  });
</script>

<style>
.map-card {
  max-width: 640px;
  margin: auto;
  background: #f8fafc;
  border-radius: 16px;
  padding: 16px;
}

.map {
  height: 300px;
  border-radius: 12px;
  overflow: hidden;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

.map-loading {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

.caption {
  margin-top: 12px;
  font-size: 0.95rem;
  text-align: center;
  color: #0f172a;
}
</style>
